name: sun_dmz

# Version 12: Behebt "Host is unreachable".
# Ursache: Die 'br_*' Container (kind: linux) haben nicht 
#          automatisch wie Switches (Bridges) agiert.
# Lösung: Hinzufügen von 'exec'-Befehlen zu allen 'br_*' Knoten,
#         um manuell eine Bridge 'br0' zu erstellen und alle
#         Schnittstellen (ethX) zu dieser Bridge hinzuzufügen.

topology:
  nodes:
    # --- Zone 1: Internet ---
    attacker:
      kind: linux
      image: alpine:latest
      exec:
        - "apk update"
        - "apk add netcat-openbsd"
        - "ip addr add 192.168.100.10/24 dev eth1"
        - "ip route del default" 
        - "ip route add default via 192.168.100.1"

    # --- Zone 2: DMZ ---
    
    waf:
      kind: linux
      # WIR HABEN DAS IMAGE SCHON GEBAUT
      # Jetzt verwenden wir den lokalen Image-Namen
      image: sun-waf-image
      
      exec:
        - "ip addr add 10.10.1.10/24 dev eth1"
        - "ip route del default" 
        - "ip route add default via 10.10.1.1"
        - "ip route add 10.10.0.0/16 via 10.10.1.2"
      # Binds (Mounts) bleiben gleich
      binds:
        # 1. Mountet unsere Reverse-Proxy-Konfiguration
        - waf_config/conf/default.conf:/etc/nginx/conf.d/default.conf:ro
        # 2. Mountet unsere WAF-Aktivierungs-Datei
        - waf_config/rules/modsecurity.conf:/etc/nginx/modsecurity.conf:ro

    ids:
      kind: linux
      # Wir verwenden ein vorgefertigtes Suricata-Image
      image: jasonish/suricata:latest

      # WICHTIG: Erhöhte Rechte, damit Suricata den Netzwerkverkehr
      # im "promiscuous mode" mitlesen kann.
      cap-add:
        - NET_ADMIN
        - NET_RAW
        - SYS_NICE

      exec:
        # IP-Konfiguration (nur für Management/Logs, nicht für Sniffing)
        - "ip addr add 10.10.1.20/24 dev eth1"
        - "ip route add 10.10.3.0/24 via 10.10.1.2"

      binds:
        # Mountet unsere Custom-Regel
        - ids_config/rules/custom.rules:/etc/suricata/rules/custom.rules:ro
        # Mountet das Log-Verzeichnis, damit wir Logs von außen lesen können
        - ids_config/logs:/var/log/suricata

      # Suricata lädt ALLE Regeln aus /etc/suricata/rules/
      cmd: "suricata -c /etc/suricata/suricata.yaml -i eth1"

    web:
      kind: linux
      image: nginx:alpine
      exec:
        - "ip addr add 10.10.1.100/24 dev eth1"
        - "ip route del default" 
        - "ip route add default via 10.10.1.1"
      binds:
        # Relative Pfade für Portabilität
        - web_config/html:/var/www/html:ro
        - web_config/conf/default.conf:/etc/nginx/conf.d/default.conf:ro

     # --- Zone 3: Interne Netze ---
    client:
      kind: linux
      image: alpine:latest
      exec:
        - "apk update" # NEU
        - "apk add netcat-openbsd" # NEU
        - "ip addr add 10.10.2.10/24 dev eth1"
        - "ip route del default" 
        - "ip route add default via 10.10.2.1"
        
    siem:
      kind: linux
      image: alpine:latest 
      exec:
        - "ip addr add 10.10.3.10/24 dev eth1"
        - "ip route del default" 
        - "ip route add default via 10.10.3.1"

# --- Router / Firewalls ---
    router_edge:
      kind: linux
      image: alpine:latest
      cap-add:
        - SYS_ADMIN
      sysctls:
        net.ipv4.ip_forward: 1
      exec:
        # 1. Installiere nftables (OHNE modprobe)
        - "apk update"
        - "apk add nftables"
        # 2. Netzwerkkonfiguration
        - "ip addr add 192.168.100.1/24 dev eth1" 
        - "ip addr add 10.10.1.1/24 dev eth2"   
        - "ip route add 10.10.0.0/16 via 10.10.1.2" 
        # 3. Führe Firewall-Skript aus
        - "chmod +x /fw_config/configure_fw.sh"
        - "/fw_config/configure_fw.sh"
      binds:
        # KORREKTUR: ':ro' entfernt
        - fw_config/edge/configure_fw.sh:/fw_config/configure_fw.sh

    # ... (router_edge bleibt unverändert) ...
        
    router_int:
      kind: linux
      image: alpine:latest
      cap-add:
        - SYS_ADMIN
      sysctls:
        net.ipv4.ip_forward: 1
      exec:
        # 1. Installiere nftables
        - "apk update"
        - "apk add nftables"
        # 2. Netzwerkkonfiguration
        - "ip addr add 10.10.1.2/24 dev eth1"   
        - "ip addr add 10.10.2.1/24 dev eth2"   
        - "ip addr add 10.10.3.1/24 dev eth3"   
        - "ip route del default" 
        - "ip route add default via 10.10.1.1" 
        # 3. Führe Firewall-Skript aus
        - "chmod +x /fw_config/configure_fw.sh"
        - "/fw_config/configure_fw.sh"
      binds:
        # Das Skript ist jetzt auch ein nftables-Skript
        - fw_config/internal/configure_fw.sh:/fw_config/configure_fw.sh

    # --- Definition der Switches ---
    br_internet:
      kind: linux
      image: alpine:latest
      exec:
        - "ip link add name br0 type bridge"
        - "ip link set br0 up"
        - "ip link set eth1 master br0"
        - "ip link set eth2 master br0"
        - "ip link set eth1 up"
        - "ip link set eth2 up"

    br_dmz:
      kind: linux
      image: alpine:latest
      exec:
        - "ip link add name br0 type bridge"
        - "ip link set br0 up"
        - "ip link set eth1 master br0"
        - "ip link set eth2 master br0"
        - "ip link set eth3 master br0"
        - "ip link set eth4 master br0"
        - "ip link set eth5 master br0"
        - "ip link set eth1 up"
        - "ip link set eth2 up"
        - "ip link set eth3 up"
        - "ip link set eth4 up"
        - "ip link set eth5 up"

    br_client:
      kind: linux
      image: alpine:latest
      exec:
        - "ip link add name br0 type bridge"
        - "ip link set br0 up"
        - "ip link set eth1 master br0"
        - "ip link set eth2 master br0"
        - "ip link set eth1 up"
        - "ip link set eth2 up"
      
    br_backend:
      kind: linux
      image: alpine:latest
      exec:
        - "ip link add name br0 type bridge"
        - "ip link set br0 up"
        - "ip link set eth1 master br0"
        - "ip link set eth2 master br0"
        - "ip link set eth1 up"
        - "ip link set eth2 up"

  links:
    # (Links Sektion bleibt unverändert)
    - endpoints: ["attacker:eth1", "br_internet:eth1"]
    - endpoints: ["router_edge:eth1", "br_internet:eth2"]

    - endpoints: ["router_edge:eth2", "br_dmz:eth1"]
    - endpoints: ["router_int:eth1", "br_dmz:eth2"]
    - endpoints: ["waf:eth1", "br_dmz:eth3"]
    - endpoints: ["ids:eth1", "br_dmz:eth4"]
    - endpoints: ["web:eth1", "br_dmz:eth5"]
        
    - endpoints: ["router_int:eth2", "br_client:eth1"]
    - endpoints: ["client:eth1", "br_client:eth2"]

    - endpoints: ["router_int:eth3", "br_backend:eth1"]
    - endpoints: ["siem:eth1", "br_backend:eth2"]