name: security_lab

topology:
  nodes:
    # --- Router/Firewall-Knoten ---
    edge_router:
      kind: linux
      image: router_edge-image
      exec:

        - "ip addr add 10.10.10.1/29 dev ethdmz"
        - "ip addr add 10.10.50.1/24 dev ethtransit"
        - "ip addr add 10.10.60.6/28 dev ethmgmt"
        - "ip addr add 192.168.1.1/24 dev ethwan"
        - "ip link set ethwan up"

        - "ip route add default via 192.168.1.1 dev ethwan"
        - "ip route add 10.10.0.0/16 via 10.10.50.2"
        - "sysctl -w net.ipv4.ip_forward=1"
        - "chmod +x /fw_config/configure_fw.sh"
        - "/fw_config/configure_fw.sh"
      binds:
        - fw_config/edge/edge_configure_fw.sh:/fw_config/configure_fw.sh
        - config/aide/aide.conf:/etc/aide.conf:ro
        - config/dns/resolv.conf:/etc/resolv.conf
        - config/chrony/chrony.conf:/etc/chrony/chrony.conf
      network-mode: none


    internal_router:
      kind: linux
      image: router_int-image
      exec:
        - "ip addr add 10.10.50.2/24 dev ethtransit"
        - "ip addr add 10.10.60.1/28 dev ethmgmt"
        - "ip addr add 10.10.20.1/29 dev ethclient"
        - "ip addr add 10.10.30.1/29 dev ethsecurity"
        - "ip addr add 10.10.40.1/29 dev ethresource"
        - "ip addr add 10.10.10.2/29 dev ethdmz"
        - "ip route add default via 10.10.50.1"
        - "sysctl -w net.ipv4.ip_forward=1"

        - "chmod +x /fw_config/configure_fw.sh"
        - "/fw_config/configure_fw.sh"
      binds:
        - fw_config/internal/internal_configure_fw.sh:/fw_config/configure_fw.sh
        - config/aide/router/aide.conf:/etc/aide.conf:ro
        - config/dns/resolv.conf:/etc/resolv.conf
        - config/chrony/chrony.conf:/etc/chrony/chrony.conf
      network-mode: none

    # --- Externe/Angreifer-Knoten (Now the REAL Internet Gateway) ---
    attacker_1:
      kind: linux
      image: attacker-image
      exec:
        # 1. Set static IP for the lab-facing interface
        - "ip addr add 192.168.1.2/24 dev eth1"
        # 2. Enable IP forwarding
        - "sysctl -w net.ipv4.ip_forward=1"
        # 4. Configure NAT to masquerade traffic from the lab (coming in eth1) out to the internet (going out eth0)
        - "nft add table ip nat"
        - "nft add chain ip nat postrouting { type nat hook postrouting priority 100 ; }"
        - "nft add rule ip nat postrouting oifname \"eth0\" masquerade"
      # REMOVED: network-mode: none (This allows it to connect to Docker's bridge for internet)

    # Zweiter Angreifer-Knoten im internen Netzwerk  
    attacker_2:
      kind: linux
      image: attacker-image
      exec:
        - "ip addr add 10.10.20.3/29 dev eth10"
        - "ip route add default via 10.10.20.1"
      network-mode: none

    # --- DMZ-Knoten (10.10.0.0/29) ---
    web_server:
      kind: linux
      image: webserver-image
      env:
        DB_HOST: "10.10.40.2"
        DB_USER: "webuser"
        DB_PORT: 3306
        DB_PASS: "VerySecureP@ssword123!"
        DB_NAME: "webapp"
        FLASK_SECRET: "VerySecureP@ssword123!"
      exec:
        - "ip addr add 10.10.10.4/29 dev eth10"
        - "ip addr add 10.10.10.5/29 dev eth1"
        - "ip addr add 10.10.60.3/28 dev ethmgmt"
        - "ip route add default via 10.10.10.2" # Gateway ist der Internal Router
        - "chmod +x /fw_config/configure_fw.sh"
        - "/fw_config/configure_fw.sh"
      binds:
        - config/webserver_setup/html:/var/www/html:ro
        - config/webserver_setup/conf/default.conf:/etc/nginx/conf.d/default.conf:ro
        - fw_config/hosts/host_configure_fw.sh:/fw_config/configure_fw.sh
        - config/dns/resolv.conf:/etc/resolv.conf
        - config/chrony/chrony.conf:/etc/chrony/chrony.conf
      network-mode: none

    reverse_proxy:
      kind: linux
      image: waf-image
      mgmt-ipv4: 172.20.20.3
      exec:
        - >
          sh -c '
            while [ ! -d /sys/class/net/eth1 ] || [ ! -d /sys/class/net/eth10 ] || [ ! -d /sys/class/net/ethmgmt ]; do sleep 0.1; done;
            ip addr add 10.10.10.3/29 dev eth10
            ip addr add 10.10.60.2/28 dev ethmgmt
            ip addr add 10.10.10.5/29 dev eth1
            ip route del default
            ip route add default via 10.10.10.2 # Default Gateway ist der Internal Router
            ip route add 192.168.1.0/24 via 10.10.10.1 # Routing externe Verbindungen Ã¼ber den Edge Router
          '
        - "chmod +x /fw_config/configure_fw.sh"
        - "/fw_config/configure_fw.sh"
      binds:
        - config/waf_setup/conf/waf.conf:/etc/nginx/conf.d/waf.conf:ro
        - fw_config/hosts/host_configure_fw.sh:/fw_config/configure_fw.sh
        - certs/cert.pem:/etc/nginx/ssl/cert.pem:ro
        - certs/key.pem:/etc/nginx/ssl/key.pem:ro
        - config/dns/resolv.conf:/etc/resolv.conf
        - config/chrony/chrony.conf:/etc/chrony/chrony.conf
      #network-mode: none

    dmz_switch:
      kind: linux
      image: switch-image
      exec:
       - >
          sh -c '
            while [ ! -d /sys/class/net/eth1 ] || [ ! -d /sys/class/net/eth2 ] || [ ! -d /sys/class/net/eth3 ]|| [ ! -d /sys/class/net/eth4 ]; do sleep 0.1; done;
              brctl addbr br0
              brctl addif br0 eth1
              brctl addif br0 eth2
              brctl addif br0 eth3
              brctl addif br0 eth4
              ip link set dev br0 up
          '
      network-mode: none

    # --- Internal-Client-Knoten (10.10.20.0/29) ---
    admin:
      kind: linux
      image: admin-image
      exec:
        - "ip addr add 10.10.20.2/29 dev eth10"
        - "ip route add default via 10.10.20.1"
      binds:
        - "sshkey/sshkey:/root/.ssh/id_rsa:ro"
        - config/dns/resolv.conf:/etc/resolv.conf
        - config/chrony/chrony.conf:/etc/chrony/chrony.conf
      network-mode: none

    client_switch:
      kind: linux
      image: switch-image
      exec:
        - "brctl addbr br0"
        - "brctl addif br0 eth1"
        - "brctl addif br0 eth2"
        - "brctl addif br0 eth3"
        - "ip link set dev br0 up"
      network-mode: none

    # --- Internal-Security-Knoten (10.10.30.0/29) ---
    siem:
      kind: linux
      image: siem-image
      mgmt-ipv4: 172.20.20.2
      exec:
        - "ip addr add 10.10.30.2/29 dev eth10"
        - "ip addr add 10.10.60.5/28 dev ethmgmt"
        - "ip route add default via 10.10.30.1"
        - "chmod +x /fw_config/configure_fw.sh"
        - "/fw_config/configure_fw.sh"
      binds:
        - fw_config/hosts/host_configure_fw.sh:/fw_config/configure_fw.sh
        - config/siem/loki-config.yaml:/etc/loki/config.yml
        - siem-demo/loki/data:/tmp/loki
        - config/aide/siem/aide.conf:/etc/aide.conf:ro
        - config/dns/resolv.conf:/etc/resolv.conf
        - config/chrony/chrony.conf:/etc/chrony/chrony.conf
      network-mode: none

    bastion:
      kind: linux
      image: bastion-image
      exec:
        - "ip addr add 10.10.30.3/29 dev eth10"
        - "ip route add default via 10.10.30.1"
      binds:
        - "sshkey/sshkey:/root/.ssh/id_rsa:ro"
        - "config/aide/bastion/aide.conf:/etc/aide.conf:ro"
        - config/dns/resolv.conf:/etc/resolv.conf
        - config/chrony/chrony.conf:/etc/chrony/chrony.conf

      network-mode: none

    timedns_server:
      kind: linux
      image: ntp_dns-image
      exec:
        - "ip addr add 10.10.30.4/29 dev eth10"
        - "ip addr add 10.10.60.7/28 dev ethmgmt"
        - "ip route add default via 10.10.30.1"
        - "chmod +x /fw_config/configure_fw.sh"
        - "/fw_config/configure_fw.sh"
      binds:
        - fw_config/hosts/host_configure_fw.sh:/fw_config/configure_fw.sh
        - config/aide/ntp_dns/aide.conf:/etc/aide.conf:ro
      network-mode: none

    security_switch:
      kind: linux
      image: switch-image
      exec:
        - "brctl addbr br0"
        - "brctl addif br0 eth1"
        - "brctl addif br0 eth2"
        - "brctl addif br0 eth3"
        - "brctl addif br0 eth4"
        - "ip link set dev br0 up"
      network-mode: none

    # --- Internal-Resource-Knoten (10.10.40.0/29) ---
    database:
      kind: linux
      image: database-image
      exec:
        - "ip addr add 10.10.40.2/29 dev eth10"
        - "ip addr add 10.10.60.4/28 dev ethmgmt"
        - "ip route add default via 10.10.40.1"
        - "chmod +x /fw_config/configure_fw.sh"
        - "/fw_config/configure_fw.sh"
      binds:
        - "config/aide/database/aide.conf:/etc/aide.conf:ro"
        - fw_config/hosts/host_configure_fw.sh:/fw_config/configure_fw.sh
        - config/dns/resolv.conf:/etc/resolv.conf
        - config/chrony/chrony.conf:/etc/chrony/chrony.conf
      network-mode: none


    resource_switch:
      kind: linux
      image: switch-image
      exec:
        - "brctl addbr br0"
        - "brctl addif br0 eth1"
        - "brctl addif br0 eth2"
        - "ip link set dev br0 up"
      network-mode: none

    # --- Management-Switch ---
    mgmt_switch:
      kind: linux
      image: switch-image
      exec:
        - "brctl addbr br0"
        - "brctl addif br0 eth1"
        - "brctl addif br0 eth2"
        - "brctl addif br0 eth3"
        - "brctl addif br0 eth4"
        - "brctl addif br0 eth5"
        - "brctl addif br0 eth6"
        - "brctl addif br0 eth7"
        - "ip link set dev br0 up"
      network-mode: none


  links:
    # Internet Verbindung
    - endpoints: ["attacker_1:eth1", "edge_router:ethwan"]

    # Edge Router Verbindungen
    - endpoints: ["edge_router:ethtransit", "internal_router:ethtransit"]
    - endpoints: ["edge_router:ethdmz", "dmz_switch:eth1"]
    - endpoints: ["edge_router:ethmgmt", "mgmt_switch:eth1"]

    # Internal Router Verbindungen
    - endpoints: ["internal_router:ethdmz", "dmz_switch:eth2"]
    - endpoints: ["internal_router:ethclient", "client_switch:eth1"]
    - endpoints: ["internal_router:ethsecurity", "security_switch:eth1"]
    - endpoints: ["internal_router:ethresource", "resource_switch:eth1"]
    - endpoints: ["internal_router:ethmgmt", "mgmt_switch:eth7"]

    # DMZ Switch Verbindungen
    - endpoints: ["dmz_switch:eth4", "web_server:eth10"]
    - endpoints: ["dmz_switch:eth3", "reverse_proxy:eth10"]

    # Verbindung Webserver - WAF/Reverse Proxy
    - endpoints: ["web_server:eth1", "reverse_proxy:eth1"]

    # Client Switch Verbindungen
    - endpoints: ["client_switch:eth2", "admin:eth10"]
    - endpoints: ["client_switch:eth3", "attacker_2:eth10"]

    # Security Switch Verbindungen
    - endpoints: ["security_switch:eth2", "siem:eth10"]
    - endpoints: ["security_switch:eth3", "bastion:eth10"]
    - endpoints: ["security_switch:eth4", "timedns_server:eth10"]

    # Resource Switch Verbindungen
    - endpoints: ["resource_switch:eth2", "database:eth10"]

    # Management Switch Verbindungen
    - endpoints: ["mgmt_switch:eth2", "web_server:ethmgmt"]
    - endpoints: ["mgmt_switch:eth3", "reverse_proxy:ethmgmt"]
    - endpoints: ["mgmt_switch:eth4", "siem:ethmgmt"]
    - endpoints: ["mgmt_switch:eth5", "timedns_server:ethmgmt"]
    - endpoints: ["mgmt_switch:eth6", "database:ethmgmt"]
