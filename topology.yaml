name: security_lab

topology:
  nodes:
    # --- Router/Firewall-Knoten ---
    edge_router:
      kind: linux
      image: alpine:latest
      exec:
        - "ip addr add 10.10.10.1/29 dev ethdmz"
        - "ip addr add 10.10.50.1/24 dev ethtransit"
        - "ip addr add 10.10.60.6/28 dev ethmgmt"
        - "ip addr add 192.168.1.1/24 dev ethwan"

        - "ip route add 10.10.0.0/16 via 10.10.50.2"
        - "sysctl -w net.ipv4.ip_forward=1"
      
    internal_router:
      kind: linux
      image: alpine:latest
      exec:
        - "ip addr add 10.10.50.2/24 dev ethtransit"
        - "ip addr add 10.10.60.1/28 dev ethmgmt"
        - "ip addr add 10.10.20.1/29 dev ethclient"
        - "ip addr add 10.10.30.1/29 dev ethsecurity"
        - "ip addr add 10.10.40.1/29 dev ethresource"
        - "ip addr add 10.10.10.2/29 dev ethdmz"
        - "ip route delete default"
        - "ip route add default via 10.10.50.1"
        - "sysctl -w net.ipv4.ip_forward=1"

    # --- Externe/Angreifer-Knoten ---
    attacker_1:
      kind: linux
      image: attacker-image
      exec:
        - "ip addr add 192.168.1.2/24 dev eth1"
        - "ip route del default"
        - "ip route add default via 192.168.1.1"

    # Zweiter Angreifer-Knoten im internen Netzwerk  
    attacker_2:
      kind: linux
      image: attacker-image
      exec:
        - "ip addr add 10.10.20.3/29 dev eth10"
        - "ip route del default"
        - "ip route add default via 10.10.20.1"

    # --- DMZ-Knoten (10.10.0.0/29) ---
    web_server:
      kind: linux
      image: nginx:alpine
      exec:
        - "ip addr add 10.10.10.4/29 dev eth10"
        - "ip addr add 10.10.10.5/29 dev eth1"
        - "ip addr add 10.10.60.3/28 dev ethmgmt"
        - "ip route del default"
        - "ip route add default via 10.10.10.2" # Gateway ist der Internal Router
      binds:
        - webserver_setup/html:/var/www/html:ro
        - webserver_setup/conf/default.conf:/etc/nginx/conf.d/default.conf:ro
      
    reverse_proxy:
      kind: linux
      image: sun-waf-image
      exec:
        - >
          sh -c '
            while [ ! -d /sys/class/net/eth1 ] || [ ! -d /sys/class/net/eth10 ] || [ ! -d /sys/class/net/ethmgmt ]; do sleep 0.1; done;
            ip addr add 10.10.10.3/29 dev eth10
            ip addr add 10.10.60.2/28 dev ethmgmt
            ip addr add 10.10.10.5/29 dev eth1
            ip route del default
            ip route add default via 10.10.10.2 # Default Gateway ist der Internal Router
          '
      binds:
        - waf_setup/conf/waf.conf:/etc/nginx/conf.d/waf.conf:ro
      
    dmz_switch:
      kind: linux
      image: alpine:latest
      exec:
       - >
          sh -c '
            while [ ! -d /sys/class/net/eth1 ] || [ ! -d /sys/class/net/eth2 ] || [ ! -d /sys/class/net/eth3 ]|| [ ! -d /sys/class/net/eth4 ]; do sleep 0.1; done;
              apk add --no-cache bridge
              brctl addbr br0
              brctl addif br0 eth1
              brctl addif br0 eth2
              brctl addif br0 eth3
              brctl addif br0 eth4
              ip link set dev br0 up
          '
        

    # --- Internal-Client-Knoten (10.10.20.0/29) ---
    admin:
      kind: linux
      image: admin-client-image
      exec:
        - "ip addr add 10.10.20.2/29 dev eth10"
        - "ip route del default"
        - "ip route add default via 10.10.20.1"
      binds:
        - "admin/sshkey/sshkey:/root/.ssh/id_rsa:ro"
      
    client_switch:
      kind: linux
      image: alpine:latest
      exec:
        - "apk add --no-cache bridge"
        - "brctl addbr br0"
        - "brctl addif br0 eth1"
        - "brctl addif br0 eth2"
        - "brctl addif br0 eth3"
        - "ip link set dev br0 up"

    # --- Internal-Security-Knoten (10.10.30.0/29) ---
    siem:
      kind: linux
      image: alpine:latest
      exec:
        - "ip addr add 10.10.30.2/29 dev eth10"
        - "ip addr add 10.10.60.5/28 dev ethmgmt"
        - "ip route del default"
        - "ip route add default via 10.10.30.1"
      
    bastion:
      kind: linux
      image: admin-client-image # Temporarily use admin image scince it got an ssh client
      exec:
        - "ip addr add 10.10.30.3/29 dev eth10"
        - "ip route del default"
        - "ip route add default via 10.10.30.1"
      binds:
        - "admin/sshkey/sshkey:/root/.ssh/id_rsa:ro"
      
    timedns_server:
      kind: linux
      image: alpine:latest
      exec:
        - "ip addr add 10.10.30.4/29 dev eth10"
        - "ip addr add 10.10.60.7/28 dev ethmgmt"
        - "ip route del default"
        - "ip route add default via 10.10.30.1"
      
    security_switch:
      kind: linux
      image: alpine:latest
      exec:
        - "apk add --no-cache bridge"
        - "brctl addbr br0"
        - "brctl addif br0 eth1" 
        - "brctl addif br0 eth2" 
        - "brctl addif br0 eth3" 
        - "brctl addif br0 eth4"
        - "ip link set dev br0 up"

    # --- Internal-Resource-Knoten (10.10.40.0/29) ---
    database:
      kind: linux
      image: alpine:latest
      exec:
        - "ip addr add 10.10.40.2/29 dev eth10"
        - "ip addr add 10.10.60.4/28 dev ethmgmt"
        - "ip route del default"
        - "ip route add default via 10.10.40.1"

      
    resource_switch:
      kind: linux
      image: alpine:latest
      exec:
        - "apk add --no-cache bridge"
        - "brctl addbr br0"
        - "brctl addif br0 eth1"
        - "brctl addif br0 eth2"
        - "ip link set dev br0 up"
      
    # --- Management-Switch ---
    mgmt_switch:
      kind: linux
      image: alpine:latest
      exec:
        - "apk add --no-cache bridge"
        - "brctl addbr br0"
        - "brctl addif br0 eth1"
        - "brctl addif br0 eth2"
        - "brctl addif br0 eth3"
        - "brctl addif br0 eth4"
        - "brctl addif br0 eth5"
        - "brctl addif br0 eth6"
        - "brctl addif br0 eth7"
        - "ip link set dev br0 up"

  links:
    # Internet Verbindung
    - endpoints: ["attacker_1:eth1", "edge_router:ethwan"]

    # Edge Router Verbindungen
    - endpoints: ["edge_router:ethtransit", "internal_router:ethtransit"]
    - endpoints: ["edge_router:ethdmz", "dmz_switch:eth1"]
    - endpoints: ["edge_router:ethmgmt", "mgmt_switch:eth1"]

    # Internal Router Verbindungen
    - endpoints: ["internal_router:ethdmz", "dmz_switch:eth2"]
    - endpoints: ["internal_router:ethclient", "client_switch:eth1"]
    - endpoints: ["internal_router:ethsecurity", "security_switch:eth1"]
    - endpoints: ["internal_router:ethresource", "resource_switch:eth1"]
    - endpoints: ["internal_router:ethmgmt", "mgmt_switch:eth7"]

    # DMZ Switch Verbindungen
    - endpoints: ["dmz_switch:eth4", "web_server:eth10"]
    - endpoints: ["dmz_switch:eth3", "reverse_proxy:eth10"]

    # Verbindung Webserver - WAF/Reverse Proxy
    - endpoints: ["web_server:eth1", "reverse_proxy:eth1"]

    # Client Switch Verbindungen
    - endpoints: ["client_switch:eth2", "admin:eth10"]
    - endpoints: ["client_switch:eth3", "attacker_2:eth10"]

    # Security Switch Verbindungen
    - endpoints: ["security_switch:eth2", "siem:eth10"]
    - endpoints: ["security_switch:eth3", "bastion:eth10"]
    - endpoints: ["security_switch:eth4", "timedns_server:eth10"]

    # Resource Switch Verbindungen
    - endpoints: ["resource_switch:eth2", "database:eth10"]

    # Management Switch Verbindungen
    - endpoints: ["mgmt_switch:eth2", "web_server:ethmgmt"]
    - endpoints: ["mgmt_switch:eth3", "reverse_proxy:ethmgmt"]
    - endpoints: ["mgmt_switch:eth4", "siem:ethmgmt"]
    - endpoints: ["mgmt_switch:eth5", "timedns_server:ethmgmt"]
    - endpoints: ["mgmt_switch:eth6", "database:ethmgmt"]
