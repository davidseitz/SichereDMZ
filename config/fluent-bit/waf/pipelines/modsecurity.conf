# -------------------------------------------------------------------
# MODSECURITY AUDIT LOG PIPELINE (LUA LOGIC)
# -------------------------------------------------------------------

[INPUT]
    Name             tail
    Path             /var/log/modsec_audit.log
    Tag              security.waf
    Read_from_Head   True
    Parser           modsec_audit_json
    Refresh_Interval 5

# 1. LIFT TRANSACTION DATA
# The JSON structure is {"transaction": {...}}.
# We lift the content of "transaction" to the root level.
[FILTER]
    Name             nest
    Match            security.waf
    Operation        lift
    Nested_under     transaction

# 2. LIFT RESPONSE DATA
# We need 'http_code' at the root for the Lua script.
# It is currently inside the 'response' object.
[FILTER]
    Name             nest
    Match            security.waf
    Operation        lift
    Nested_under     response

# 3. CLASSIFY TRAFFIC (LUA)
# This runs the script to add the "status" field:
# - BLOCKED (403)
# - SUSPICIOUS (200 + Alerts)
# - ALLOWED (200 + No Alerts)
[FILTER]
    Name             lua
    Match            security.waf
    script           /etc/fluent-bit/scripts/waf_logic.lua
    call             determine_waf_status

# 4. OUTPUT TO LOKI
[OUTPUT]
    Name             loki
    Match            security.waf
    Host             10.10.30.2
    Port             3100
    
    # Label the logs with the status we calculated
    Labels           job=modsecurity, host=waf_debian, status=$status, client=$client_ip
    
    # Send the full JSON payload
    Line_Format      json
    
    # Optional: If you want to drop "ALLOWED" logs from Loki to save space,
    # you can uncomment the Stream_Processor or Grep filter above.
    # Currently, this sends ALL logs.
