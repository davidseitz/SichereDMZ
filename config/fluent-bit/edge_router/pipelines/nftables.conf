[INPUT]
    Name             tail
    # Adjust this path to where your nftables logs are actually written.
    # If they go to kern.log, use that.
    Path             /var/log/nftables.log
    Tag              net.nftables
    Read_from_Head   True
    # We do NOT use a parser here. We read the raw line into the "log" key.

# 1. PARSE & NORMALIZE (LUA)
[FILTER]
    Name             lua
    Match            net.nftables
    script           /etc/fluent-bit/scripts/nftables_parser.lua
    call             parse_nftables

# 2. FILTER OUT NOISE (Optional)
# If parsing failed (no rule_name), drop it
[FILTER]
    Name             grep
    Match            net.nftables
    Regex            rule_name .+

# 3. OUTPUT TO LOKI
[OUTPUT]
    Name             loki
    Match            net.nftables
    Host             10.10.30.2
    Port             3100
    
    # Critical Labels for Firewalls:
    # 1. Action (Allow vs Drop)
    # 2. Protocol (TCP vs UDP)
    # 3. Host (Where the log came from)
    Labels           job=nftables, host=edge_router_debian, action=$action, protocol=$protocol, rule_name=$rule_name
    
    Line_Format      json
