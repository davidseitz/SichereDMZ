# -------------------------------------------------------------------
# CUSTOM SSH LOG PIPELINE
# -------------------------------------------------------------------

[INPUT]
    Name             tail
    Path             /var/log/ssh-custom.log
    Tag              system.ssh
    Read_from_Head   True

# 1. CLEAN NOISE
# Filter out noisy startup messages like "Server listening on..."
[FILTER]
    Name             grep
    Match            system.ssh
    Exclude          log ^Server listening on
    Exclude          log ^Disconnected from user
    
# 2. ROUTE/REWRITE TAGS
# FIX: Added 'log' as the explicit key field to satisfy the 4-value requirement 
# of the 'Rule' property in your Fluent Bit version (Rule Key Regex NewTag EndRoutingFlag)
[FILTER]
    Name             rewrite_tag
    Match            system.ssh
    
    # Accepted Connections
    Rule             log ^Accepted\s+.*$             ssh.accepted          true
    
    # Failed Authentication Attempts
    Rule             log ^Failed\s+.*$                ssh.failed            true
    
    # Received Disconnects
    Rule             log ^Received\s+disconnect\s+.*$ ssh.disconnect        true
    
    # Logs not matching any of the above will keep the system.ssh tag and be dropped 
    # by the output plugin's Match=ssh.* rule.

# 3. PARSE ACCEPTED CONNECTIONS
[FILTER]
    Name             parser
    Match            ssh.accepted
    Key_Name         log
    Parser           ssh_accepted
    Reserve_Data     On

# 4. PARSE FAILED AUTHENTICATION ATTEMPTS
[FILTER]
    Name             parser
    Match            ssh.failed
    Key_Name         log
    Parser           ssh_failed_auth
    Reserve_Data     On

# 5. PARSE DISCONNECT MESSAGES
[FILTER]
    Name             parser
    Match            ssh.disconnect
    Key_Name         log
    Parser           ssh_disconnect
    Reserve_Data     On
    
# 5. OUTPUT
[OUTPUT]
    Name             loki
    Match            ssh.*
    Host             10.10.30.2
    Port             3100
    
    # Label by User and Remote IP for quick security monitoring
    Labels           job=sshd, host=siem_alpine, user=$user, remote_ip=$remote_ip
    
    Line_Format      json
