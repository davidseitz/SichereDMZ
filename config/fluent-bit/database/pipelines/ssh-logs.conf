# -------------------------------------------------------------------
# CUSTOM SSH LOG PIPELINE
# -------------------------------------------------------------------

[INPUT]
    Name             tail
    Path             /var/log/ssh-custom.log
    Tag              system.ssh
    Read_from_Head   True

# 1. CLEAN NOISE
# Filter out noisy startup messages like "Server listening on..."
[FILTER]
    Name             grep
    Match            system.ssh
    Exclude          log ^Server listening on
    Exclude          log ^Disconnected from user
    # Keep the tag as system.ssh

# 2. PARSE ACCEPTED CONNECTIONS
[FILTER]
    Name             parser
    Match            system.ssh
    Key_Name         log
    Parser           ssh_accepted
    # Use GREP's Regex for conditional parsing (Fluent Bit Best Practice)
    Regex            log ^Accepted
    Reserve_Data     On

# 3. PARSE FAILED AUTHENTICATION ATTEMPTS
[FILTER]
    Name             parser
    Match            system.ssh
    Key_Name         log
    Parser           ssh_failed_auth
    Regex            log ^Failed
    Reserve_Data     On

# 4. PARSE DISCONNECT MESSAGES
[FILTER]
    Name             parser
    Match            system.ssh
    Key_Name         log
    Parser           ssh_disconnect
    Regex            log ^Received disconnect
    Reserve_Data     On
    
# 5. OUTPUT
[OUTPUT]
    Name             loki
    Match            system.ssh
    Host             10.10.30.2
    Port             3100
    
    # Label by User and Remote IP for quick security monitoring
    Labels           job=sshd, host=database_alpine, user=$user, remote_ip=$remote_ip
    
    Line_Format      json
