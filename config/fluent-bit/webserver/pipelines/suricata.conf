# -------------------------------------------------------------------
# SURICATA EVE.JSON PIPELINE (WITH PRIORITY EXTRACTION - FIXED FOR V4.2+)
# -------------------------------------------------------------------

[INPUT]
    Name             tail
    Path             /var/log/suricata/eve.json
    Tag              security.suricata
    Read_from_Head   True

# 1. PARSE
# Applies the JSON parser, converting the log line into structured fields.
[FILTER]
    Name             parser
    Match            security.suricata
    Key_Name         log
    Parser           suricata_json
    Reserve_Data     Off

# 2. NEST/UNNEST ALERT DATA
# FIX: Use 'Nested_under' to specify the key to lift.
# Note: Condition_key is not supported in 'nest'. The filter will safely ignore 
# records that do not contain the 'alert' key (like flow logs).
[FILTER]
    Name             nest
    Match            security.suricata
    Operation        lift
    Nested_under     alert

# 3. FLATTEN/ENRICH
# Rename event_type and priority fields to keep labels concise
[FILTER]
    Name             modify
    Match            security.suricata
    # Rename event_type field to 'event'
    Rename           event_type event
    # Rename priority field (now at the root) to 'alert_priority'
    Rename           priority alert_priority
    
# 4. OUTPUT
[OUTPUT]
    Name             loki
    Match            security.suricata
    Host             10.10.30.2
    Port             3100
    
    # CRITICAL LABELS:
    # 1. event: Alerts, Flows, HTTP, etc.
    # 2. action: Alert action (drop/reject/pass)
    # 3. alert_priority: The severity level (1, 2, 3...)
    Labels           job=suricata, host=webserver_alpine, event=$event, action=$action, priority=$alert_priority
    
    Line_Format      json
