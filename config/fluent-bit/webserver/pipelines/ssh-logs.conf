# -------------------------------------------------------------------
# CUSTOM SSH LOG PIPELINE (FINALIZED CONFIGURATION)
# -------------------------------------------------------------------

[INPUT]
    Name             tail
    Path             /var/log/ssh-custom.log
    Tag              system.ssh
    Read_from_Head   True

# 1. CLEAN NOISE
# Filter out noisy startup messages like "Server listening on..."
[FILTER]
    Name             grep
    Match            system.ssh
    Exclude          log ^Server listening on
    Exclude          log ^Disconnected from user
    
# 2. ROUTE/REWRITE TAGS
# Separates logs into specific streams based on content.
[FILTER]
    Name             rewrite_tag
    Match            system.ssh
    
    # Successful Connections
    Rule             log ^Accepted\s+.*$             ssh.accepted          true
    
    # Failed Authentication Attempts (Post-Preauth: e.g., bad key)
    Rule             log ^Failed\s+.*$                ssh.failed_auth       true
    
    # Invalid User Attempts (Preauth: Unknown user)
    Rule             log ^Invalid\s+user\s+.*$        ssh.invalid_user      true
    
    # Connection Closed (Preauth: Ambiguous Close)
    Rule             log ^Connection\s+closed\s+by\s+.*$ ssh.closed_preauth  true
    
    # Received Disconnects (Post-Auth)
    Rule             log ^Received\s+disconnect\s+.*$ ssh.disconnect        true
    
# 3. PARSE ACCEPTED CONNECTIONS
[FILTER]
    Name             parser
    Match            ssh.accepted
    Key_Name         log
    Parser           ssh_accepted
    Reserve_Data     On

# 3a. ENRICH ACCEPTED CONNECTIONS (Adds SUCCESS field)
[FILTER]
    Name             modify
    Match            ssh.accepted
    Add              event_type "successful_login"

# 4. PARSE FAILED AUTHENTICATION ATTEMPTS (POST-PREAUTH)
[FILTER]
    Name             parser
    Match            ssh.failed_auth
    Key_Name         log
    Parser           ssh_failed_auth
    Reserve_Data     On

# 4a. ENRICH FAILED AUTH (Adds INVALID KEY/PASSWORD field)
[FILTER]
    Name             modify
    Match            ssh.failed_auth
    Add              event_type "invalid_auth"

# 5. PARSE DISCONNECT MESSAGES (POST-AUTH)
[FILTER]
    Name             parser
    Match            ssh.disconnect
    Key_Name         log
    Parser           ssh_disconnect
    Reserve_Data     On
    
# 6. PARSE INVALID USER (PREAUTH)
[FILTER]
    Name             parser
    Match            ssh.invalid_user
    Key_Name         log
    Parser           ssh_invalid_user
    Reserve_Data     On

# 6a. ENRICH INVALID USER (Adds INVALID USER field)
[FILTER]
    Name             modify
    Match            ssh.invalid_user
    Add              event_type "invalid_user"

# 7. PARSE CONNECTION CLOSED (PREAUTH)
[FILTER]
    Name             parser
    Match            ssh.closed_preauth
    Key_Name         log
    Parser           ssh_closed_preauth
    Reserve_Data     On

# 7a. ENRICH CLOSED PREAUTH (Treat as Invalid Auth for a known user/session)
[FILTER]
    Name             modify
    Match            ssh.closed_preauth
    Add              event_type "invalid_auth"
    
# 8. OUTPUT
[OUTPUT]
    Name             loki
    Match            ssh.*
    Host             10.10.30.2
    Port             3100
    
    # --- Authentication for Nginx ---
    http_user        loki-user
    http_passwd      a_secretPW#15secEt
    # --------------------------------


    # Label by User and Remote IP for quick security monitoring
    Labels           job=sshd, host=webserver_alpine, user=$user, remote_ip=$remote_ip
    
    Line_Format      json
