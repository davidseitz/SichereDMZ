# -------------------------------------------------------------------
# CUSTOM SSH LOG PIPELINE
# -------------------------------------------------------------------

[INPUT]
    Name             tail
    Path             /var/log/ssh-custom.log
    Tag              system.ssh
    Read_from_Head   True

# 1. CLEAN
# Filter out noisy startup messages like "Server listening on..."
[FILTER]
    Name             grep
    Match            system.ssh
    Exclude          log ^Server listening on
    Exclude          log ^Disconnected from user

# 2. PARSE ACCEPTED CONNECTIONS
# Applies parser #1 to lines containing "Accepted"
[FILTER]
    Name             parser
    Match            system.ssh
    Key_Name         log
    Parser           ssh_accepted
    # Only try to parse lines that start with 'Accepted'
    Exclude_Text     log ^(?!Accepted)
    Reserve_Data     On

# 3. PARSE FAILED AUTHENTICATION ATTEMPTS (UPDATED PARSER NAME)
# Applies the parser to all lines containing "Failed"
[FILTER]
    Name             parser
    Match            system.ssh
    Key_Name         log
    Parser           ssh_failed_auth
    # Only try to parse lines that start with 'Failed'
    Exclude_Text     log ^(?!Failed)
    Reserve_Data     On

# 4. PARSE DISCONNECT MESSAGES
# Applies parser #3 to lines containing "Received disconnect"
[FILTER]
    Name             parser
    Match            system.ssh
    Key_Name         log
    Parser           ssh_disconnect
    # Only try to parse lines that start with 'Received disconnect'
    Exclude_Text     log ^(?!Received disconnect)
    Reserve_Data     On
    
# 5. OUTPUT
[OUTPUT]
    Name             loki
    Match            system.ssh
    Host             10.10.30.2
    Port             3100
    
    # Label by User and Remote IP for quick security monitoring
    Labels           job=sshd, host=webserver_alpine, user=$user, remote_ip=$remote_ip
    
    Line_Format      json
