# This is the static nftables configuration for the Edge Router (FWE).
# It has been revised to separate TCP (80, 443) and UDP (443 - QUIC) web traffic.

flush ruleset

table ip nat {
	chain postrouting {
		type nat hook postrouting priority 100; policy accept;

        # Translate all traffic from internal networks (10.10.0.0/16)
        # when exiting the WAN interface.
        ip saddr 10.10.0.0/16 oifname "ethwan" masquerade
	}
}

table inet filter {

    chain INPUT {
        iifname lo accept

        type filter hook input priority 0; policy drop;
        ct state established,related accept

        #ip protocol icmp accept

        # Bastion -> Edge Router INBOUND ssh via on 3025 via ethmgmt
        iifname "ethmgmt" \
            ip saddr 10.10.30.3 ip daddr 10.10.60.6 tcp dport 3025 \
            log group 10 prefix "FWE_ALLOW_BASTION_EDGE_ROUTER: " counter accept
    }

    chain OUTPUT {
        type filter hook output priority 0; policy drop;

        # 1. Allow established/related traffic
        ct state established,related accept

        #ip protocol icmp accept

        # F(TBD) Edge Router (10.10.50.1) -> Internet TCP Web OUTBOUND (HTTP/2 fallback)
        oifname "ethwan" tcp dport { 80, 443 } \
            log group 10 prefix "FWE_ALLOW_ER_TCP_WEB: " counter accept
            
        # F(TBD) Edge Router (10.10.50.1) -> Internet UDP Web OUTBOUND (QUIC/HTTP/3)
        oifname "ethwan" udp dport 443 \
            log group 10 prefix "FWE_ALLOW_ER_UDP_QUIC: " counter accept
        
        # Edge Router -> SIEM OUTBOUND Logs TCP
        oifname "ethtransit" ip daddr 10.10.30.2 tcp dport 3100 \
            log group 10 prefix "FWE_ALLOW_EDGE_SIEM_TCP_LOG: " counter accept
        
        # Edge Router -> SIEM OUTBOUND Logs UDP
        oifname "ethtransit" ip daddr 10.10.30.2 udp dport 3100 \
            log group 10 prefix "FWE_ALLOW_EDGE_SIEM_UDP_LOG: " counter accept

        # Edge Router -> DNS OUTBOUND UDP
        oifname "ethtransit" ip daddr 10.10.30.4 udp dport { 53, 123 } \
            log group 10 prefix "FWE_ALLOW_EDGE_DNS_TIME: " counter accept

        # Edge Router -> DNS OUTBOUND UDP
        oifname "ethtransit" ip daddr 10.10.30.4 udp dport 53 \
            log group 10 prefix "FWE_ALLOW_EDGE_DNS_TCP: " counter accept
    }

    chain FORWARD {
        type filter hook forward priority 0; policy drop;
        ct state established,related accept

        ip protocol icmp accept

        # F1 Attacker 1 (192.168.1.2) -> Rev Proxy (10.10.10.3) TCP Web via ethwan -> ethdmz
        iifname "ethatt" oifname "ethdmz" \
            ip saddr 192.168.1.2 ip daddr 10.10.10.3 tcp dport { 80, 443 } \
            log group 10 prefix "FWE_ALLOW_ATT1_WAF_PROXY_TCP: " counter accept

        iifname "ethwan" oifname "ethdmz" \
            ip daddr 10.10.10.3 tcp dport { 80, 443 } \
            log group 10 prefix "FWE_ALLOW_INTERNET_WAF_PROXY_TCP: " counter accept

        # F(2,5,7,14,15) Internal Router (ALL Subnets) (10.10.0.0/16) -> Internet TCP Web
        iifname "ethtransit" oifname "ethwan" \
            ip saddr 10.10.0.0/16 tcp dport { 80, 443 } \
            log group 10 prefix "FWE_ALLOW_INTERNAL_TO_INTERNET_TCP: " counter accept
        
        # F(2,5,7,14,15) Internal Router (ALL Subnets) (10.10.0.0/16) -> Internet UDP QUIC
        iifname "ethtransit" oifname "ethwan" \
            ip saddr 10.10.0.0/16 udp dport 443 \
            log group 10 prefix "FWE_ALLOW_INTERNAL_TO_INTERNET_QUIC: " counter accept


        # F34 DNS Time Server -> Internet DNS/NTP via ethwan -> ethdmz (No change, this was already UDP)
        iifname "ethtransit" oifname "ethwan" \
            ip saddr 10.10.30.4 udp dport { 53, 123 } \
            log group 10 prefix "FWE_ALLOW_INTERNAL_DNS_TIME_UDP: " counter accept

        # F34 DNS Time Server -> Internet DNS/NTP via ethwan -> ethdmz (No change, this was already UDP)
        iifname "ethtransit" oifname "ethwan" \
            ip saddr 10.10.30.4 tcp dport 53 \
            log group 10 prefix "FWE_ALLOW_INTERNAL_DNS_TCP: " counter accept
            
        # 3. Explizites 'Log & Drop' am Ende
        log group 10 prefix "FWE_DENIED_FWD: " drop
    }
}