# This is the static nftables configuration for the Internal Router (FWI).
# All combined TCP/UDP web rules have been split for clarity (TCP vs. QUIC).

flush ruleset

table inet filter {

    chain INPUT {
        iifname lo accept

        type filter hook input priority 0; policy drop;

        # 1. Allow established/related traffic
        ct state established,related accept

        #ip protocol icmp accept

        # F8 Bastion (10.10.30.3) -> Internal Router (10.10.60.1) SSH via ethsecurity
        # NOTE: ip daddr 10.10.60.1 is the D-IP for the router's ethmgmt interface, which is fine, 
        # but consider if 10.10.30.1 (ethsecurity) is the intended destination address.
        iifname "ethsecurity" \
            ip saddr 10.10.30.3 ip daddr 10.10.60.1 tcp dport 3025 \
            log group 10 prefix "FWI_ALLOW_BASTION_INTERNAL_ROUTER: " counter accept
    }

    chain OUTPUT {
        type filter hook output priority 0; policy drop;
        #ip protocol icmp accept

        # 1. Allow established/related traffic
        ct state established,related accept

        # F19 Internal Router (10.10.30.1) -> SIEM (10.10.30.2) TCP/UDP Log via ethsecurity
        # (Assuming Dport 3100 is the logging port, splitting for completeness)
        oifname "ethsecurity" \
            ip daddr 10.10.30.2 tcp dport 3100 \
            log group 10 prefix "FWI_ALLOW_ROUTER_LOGS_SIEM_TCP: " counter accept
        oifname "ethsecurity" \
            ip daddr 10.10.30.2 udp dport 3100 \
            log group 10 prefix "FWI_ALLOW_ROUTER_LOGS_SIEM_UDP: " counter accept

        # F33 Internal Router (10.10.50.2) -> Internet TCP Web OUTBOUND -> ethtransit
        oifname "ethtransit" \
            ip saddr 10.10.50.2 tcp dport { 80, 443 } \
            log group 10 prefix "FWI_ALLOW_IR_INTERNET_TCP: " counter accept

        # F33 Internal Router (10.10.50.2) -> Internet UDP QUIC OUTBOUND -> ethtransit
        oifname "ethtransit" \
            ip saddr 10.10.50.2 udp dport 443 \
            log group 10 prefix "FWI_ALLOW_IR_INTERNET_QUIC: " counter accept

        # F25 Internal Router -> Time/DNS (10.10.30.4) DNS/NTP OUTBOUND -> ethsecurity (No change, already UDP)
        oifname "ethsecurity" \
            ip daddr 10.10.30.4 udp dport { 53, 123 } \
            log group 10 prefix "FWI_ALLOW_ROUTER_DNS_TIME: " counter accept

        # F25 Internal Router -> Time/DNS (10.10.30.4) DNS/NTP OUTBOUND -> ethsecurity (No change, already UDP)
        oifname "ethsecurity" \
            ip daddr 10.10.30.4 udp dport 53 \
            log group 10 prefix "FWI_ALLOW_ROUTER_DNS_TCP: " counter accept
    }

    chain FORWARD {
        type filter hook forward priority 0; policy drop;
    
        #ip protocol icmp accept

        # 1. Allow established/related traffic
        ct state established,related accept

        # --- NON-WEB TRAFFIC (No change needed) ---
        # F4 Webserver -> Database MariaDB
        iifname "ethdmz" oifname "ethresource" ip saddr 10.10.10.4 ip daddr 10.10.40.2 tcp dport 3306 \
            log group 10 prefix "FWI_ALLOW_WEB_DATABASE: " counter accept

        # F6 Admin -> Bastion SSH
        iifname "ethclient" oifname "ethsecurity" ip saddr 10.10.20.2 ip daddr 10.10.30.3 tcp dport 3025 \
            log group 10 prefix "FWI_ALLOW_ADMIN_BASTION: " counter accept

        # F9, F10, F11, F12, F13, F(TBD) Bastion -> Management Subnet (10.10.60.x)
        # Using the dport 3025 (SSH) from the original rules
        iifname "ethsecurity" oifname "ethmgmt" ip saddr 10.10.30.3 tcp dport 3025 \
            ip daddr { 10.10.60.4, 10.10.60.5, 10.10.60.6, 10.10.60.3, 10.10.60.2, 10.10.60.7 } \
            log group 10 prefix "FWI_ALLOW_BASTION_MGMT_SSH: " counter accept
            # NOTE: I combined F9-F13 and F(TBD) into one rule using a set for efficiency and cleaner config.

        # ----------- DNS/Time UDP -----------
        # F22, F23 Admin/Attacker 2 -> Time/DNS
        iifname "ethclient" oifname "ethsecurity" ip daddr 10.10.30.4 udp dport { 53, 123 } \
            ip saddr { 10.10.20.2, 10.10.20.3 } \
            log group 10 prefix "FWI_ALLOW_CLIENT_DNS_TIME_UDP: " counter accept
            
        # F26 Edge Router -> Time/DNS
        iifname "ethtransit" oifname "ethsecurity" ip saddr 10.10.50.1 ip daddr 10.10.30.4 udp dport { 53, 123 } \
            log group 10 prefix "FWI_ALLOW_EDGE_ROUTER_DNS_TIME_UDP: " counter accept
            
        # F24 Database -> Time/DNS
        iifname "ethresource" oifname "ethsecurity" ip saddr 10.10.40.2 ip daddr 10.10.30.4 udp dport { 53, 123 } \
            log group 10 prefix "FWI_ALLOW_DATABASE_DNS_TIME_UDP: " counter accept
            
        # F27 Webserver -> Time/DNS
        iifname "ethdmz" oifname "ethsecurity" ip saddr 10.10.10.4 ip daddr 10.10.30.4 udp dport { 53, 123 } \
            log group 10 prefix "FWI_ALLOW_WEB_DNS_TIME_UDP: " counter accept
            
        # F28 Waf/Rev Proxy -> Time/DNS
        iifname "ethdmz" oifname "ethsecurity" ip saddr 10.10.10.3 ip daddr 10.10.30.4 udp dport { 53, 123 } \
            log group 10 prefix "FWI_ALLOW_WAF_PROXY_DNS_TIME_UDP: " counter accept

        # ----------- DNS TCP -----------

        # F22, F23 Admin/Attacker 2 -> Time/DNS
        iifname "ethclient" oifname "ethsecurity" ip daddr 10.10.30.4 tcp dport 53 \
            ip saddr { 10.10.20.2, 10.10.20.3 } \
            log group 10 prefix "FWI_ALLOW_CLIENT_DNS_TCP: " counter accept
            
        # F26 Edge Router -> Time/DNS
        iifname "ethtransit" oifname "ethsecurity" ip saddr 10.10.50.1 ip daddr 10.10.30.4 tcp dport 53 \
            log group 10 prefix "FWI_ALLOW_EDGE_ROUTER_DNS_TCP: " counter accept
            
        # F24 Database -> Time/DNS
        iifname "ethresource" oifname "ethsecurity" ip saddr 10.10.40.2 ip daddr 10.10.30.4 tcp dport 53 \
            log group 10 prefix "FWI_ALLOW_DATABASE_DNS_TCP: " counter accept
            
        # F27 Webserver -> Time/DNS
        iifname "ethdmz" oifname "ethsecurity" ip saddr 10.10.10.4 ip daddr 10.10.30.4 tcp dport 53 \
            log group 10 prefix "FWI_ALLOW_WEB_DNS_TCP: " counter accept
            
        # F28 Waf/Rev Proxy -> Time/DNS
        iifname "ethdmz" oifname "ethsecurity" ip saddr 10.10.10.3 ip daddr 10.10.30.4 tcp dport 53 \
            log group 10 prefix "FWI_ALLOW_WAF_PROXY_DNS_TCP: " counter accept
        
        # F16, F18, F21, F20 Traffic to SIEM (3100)
        # Assuming Dport 3100 is for logs, splitting into TCP/UDP
        
        # TCP LOGS TO SIEM
        meta l4proto tcp th dport 3100 ip daddr 10.10.30.2 \
            iifname { "ethresource", "ethtransit", "ethdmz" } oifname "ethsecurity" \
            ip saddr { 10.10.40.2, 10.10.50.1, 10.10.10.4, 10.10.10.3 } \
            log group 10 prefix "FWI_ALLOW_LOGS_SIEM_TCP: " counter accept
        
        # UDP LOGS TO SIEM
        meta l4proto udp th dport 3100 ip daddr 10.10.30.2 \
            iifname { "ethresource", "ethtransit", "ethdmz" } oifname "ethsecurity" \
            ip saddr { 10.10.40.2, 10.10.50.1, 10.10.10.4, 10.10.10.3 } \
            log group 10 prefix "FWI_ALLOW_LOGS_SIEM_UDP: " counter accept
        
        # --- INTERNET-BOUND WEB TRAFFIC (SPLIT TCP/QUIC) ---

        # F7, F2 Admin/Attacker 2 -> Internet TCP Web
        iifname "ethclient" oifname "ethtransit" ip saddr { 10.10.20.2, 10.10.20.3 } tcp dport { 80, 443 } \
            log group 10 prefix "FWI_ALLOW_CLIENT_INTERNET_TCP: " counter accept
        # F7, F2 Admin/Attacker 2 -> Internet UDP QUIC
        iifname "ethclient" oifname "ethtransit" ip saddr { 10.10.20.2, 10.10.20.3 } udp dport 443 \
            log group 10 prefix "FWI_ALLOW_CLIENT_INTERNET_QUIC: " counter accept
            
        # F14 SIEM -> Internet TCP Web
        iifname "ethsecurity" oifname "ethtransit" ip saddr 10.10.30.2 tcp dport { 80, 443 } \
            log group 10 prefix "FWI_ALLOW_SIEM_INTERNET_TCP: " counter accept
        # F14 SIEM -> Internet UDP QUIC
        iifname "ethsecurity" oifname "ethtransit" ip saddr 10.10.30.2 udp dport 443 \
            log group 10 prefix "FWI_ALLOW_SIEM_INTERNET_QUIC: " counter accept

        # F15 Database -> Internet TCP Web
        iifname "ethresource" oifname "ethtransit" ip saddr 10.10.40.2 tcp dport { 80, 443 } \
            log group 10 prefix "FWI_ALLOW_DB_INTERNET_TCP: " counter accept
        # F15 Database -> Internet UDP QUIC
        iifname "ethresource" oifname "ethtransit" ip saddr 10.10.40.2 udp dport 443 \
            log group 10 prefix "FWI_ALLOW_DB_INTERNET_QUIC: " counter accept
        
        # Webserver -> Internet TCP Web
        iifname "ethdmz" oifname "ethtransit" ip saddr 10.10.10.4 tcp dport { 80, 443 } \
            log group 10 prefix "FWI_ALLOW_WEBSERVER_INTERNET_TCP: " counter accept
        # Webserver -> Internet UDP QUIC
        iifname "ethdmz" oifname "ethtransit" ip saddr 10.10.10.4 udp dport 443 \
            log group 10 prefix "FWI_ALLOW_WEBSERVER_INTERNET_QUIC: " counter accept

        # Bastion -> Internet TCP Web
        iifname "ethsecurity" oifname "ethtransit" ip saddr 10.10.30.3 tcp dport { 80, 443 } \
            log group 10 prefix "FWI_ALLOW_BASTION_INTERNET_TCP: " counter accept
        # Bastion -> Internet UDP QUIC
        iifname "ethsecurity" oifname "ethtransit" ip saddr 10.10.30.3 udp dport 443 \
            log group 10 prefix "FWI_ALLOW_BASTIONINTERNET_QUIC: " counter accept

        # F34a Time/DNS -> Internet TCP Web (for updates/checks)
        iifname "ethsecurity" oifname "ethtransit" ip saddr 10.10.30.4 tcp dport { 80, 443 } \
            log group 10 prefix "FWI_ALLOW_DNS_INTERNET_UPDATE_TCP: " counter accept

        # F34a Time/DNS -> Internet UDP QUIC
        iifname "ethsecurity" oifname "ethtransit" ip saddr 10.10.30.4 udp dport 443 \
            log group 10 prefix "FWI_ALLOW_DNS_INTERNET_UPDATE_QUIC: " counter accept

        # F34b Time/DNS -> DNS 
        iifname "ethsecurity" oifname "ethtransit" \
            ip saddr 10.10.30.4 tcp dport 53 \
            log group 10 prefix "FWI_ALLOW_DNS_INTERNET_DNS_TCP: " counter accept
           
        # F34b Time/DNS -> DNS and Time
        iifname "ethsecurity" oifname "ethtransit" \
            ip saddr 10.10.30.4 udp dport { 53, 123 } \
            log group 10 prefix "FWI_ALLOW_DNS_INTERNET_DNS_TIME_UDP: " counter accept
            
        # --- 3. Log & Drop remaining forward traffic ---
        log group 10 prefix "FWI_DENIED_FWD: " counter drop
    }
}