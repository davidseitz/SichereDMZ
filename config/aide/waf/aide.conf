# AIDE Configuration for OWASP/Nginx WAF
# Tailored for Debian-based ModSecurity CRS Image

# --- System Settings ---
@@x_include_setenv UPAC_settingsd /etc/aide/aide.settings.d
@@x_include_setenv PATH /bin:/usr/bin:/sbin:/usr/sbin

# Database Locations
# These match the logic in your start_waf.sh script
database_in=file:/var/lib/aide/aide.db.gz
database_out=file:/var/lib/aide/aide.db.new
database_new=file:/var/lib/aide/aide.db.new
gzip_dbout=yes

# --- Reporting (JSON to Stdout) ---
# This ensures the output is piped correctly to your logs via the cron job
report_format = json
report_url = stdout

# --- Groups / Macros ---
Checksums = sha512
OwnerMode = p+u+g+ftype
Size = s+b
InodeData = OwnerMode+n+i+Size+l+X
StaticFile = m+c+Checksums

# Full: Checks EVERYTHING (Permissions, Inode, User, Group, Size, Time, Checksum)
Full = InodeData+StaticFile

# VarFile: For files where content changes but permissions/inode stay same
VarFile = OwnerMode+n+l+X

# --- 1. CORE SYSTEM INTEGRITY ---
/boot   Full
/bin    Full
/sbin   Full
/lib    Full
/lib64  Full
/usr/bin    Full
/usr/sbin   Full
/usr/lib    Full
/opt        Full
/root       Full

# --- 2. WAF & NGINX SPECIFIC PROTECTION ---

# Main Nginx Configuration
/etc/nginx/nginx.conf  Full
/etc/nginx/conf.d      Full

# !!! WAF CONFIGURATION !!!
# Explicitly protecting the custom WAF config you mentioned
/etc/nginx/conf.d/waf_conf Full

# ModSecurity Configuration
/etc/modsecurity.d     Full
/etc/modsecurity       Full

# Web Content (standard Nginx path)
/usr/share/nginx/html  Full

# --- 3. CONFIGURATION & NETWORK ---

# Watch /etc generally
/etc    Full

# !!! CRITICAL: resolv.conf !!!
# Since this is mounted and static, we use 'Full'.
# AIDE will alert on ANY change (DNS hijacking, unmounting, permission shift).
/etc/resolv.conf Full

# Hosts/Hostname (Standard protection)
/etc/hosts Full
/etc/hostname Full

# Exclude dynamic/noise in /etc
!/etc/mtab
!/etc/ld.so.cache
!/etc/alternatives

# SSH Config (Protect Keys and Config)
/etc/ssh/sshd_config   Full
# Exclude keys generated at runtime to prevent constant alerts on fresh deployments
!/etc/ssh/ssh_host_*_key
!/etc/ssh/ssh_host_*_key.pub

# --- 4. ADMIN & OPERATIONS ---

# Protect Admin Home (SSH keys, history)
/home/admin  Full
!/home/admin/.ssh/known_hosts

# Protect Startup Scripts
/start_waf.sh Full
/docker-entrypoint.sh Full

# Protect the AIDE Database itself
/var/lib/aide/aide.db.gz StaticFile

# --- 5. EXCLUSIONS (NOISE REDUCTION) ---

# Ignore Log Content (but track attributes if needed, or ignore completely)
!/var/log/nginx
!/var/log/modsec_audit.log
!/var/log/ssh-custom.log
!/var/log/aide.json
!/var/log/aide.log
!/var/log/lastlog
!/var/log/wtmp
!/var/log/btmp

# System Runtime Directories (Volatile)
!/var/run
!/run
!/var/tmp
!/tmp
!/proc
!/sys
!/dev
!/var/cache
!/var/lock
